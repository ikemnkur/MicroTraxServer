<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Purchases (Last 48 Hours)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    /* Global Styles */
    body {
      font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    .container-custom {
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 20px;
    }
    /* Controls */
    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .controls-container .form-control,
    .controls-container .form-select {
      flex: 1 1 200px;
    }
    .sort-container {
      display: flex;
      gap: 10px;
    }
    /* Purchase List */
    .purchase-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .purchase-item {
      background: #fff;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .purchase-item:hover {
      background: #f1f1f1;
    }
    /* User Info Section */
    .user-info-container {
      border: 1px solid #e0e0e0;
      background: #fff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
    }
    /* Modal Styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1050;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <h1>Admin Purchases (Last 48 Hours)</h1>

    <!-- Search / Filter / Sort Controls -->
    <div class="controls-container">
      <input
        id="searchInput"
        type="text"
        placeholder="Search by username, reference, etc."
        class="form-control"
      />
      <select id="statusFilter" class="form-select">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Completed">Completed</option>
      </select>
      <div id="sortContainer" class="sort-container">
        <button class="btn btn-secondary" data-field="created_at">Date</button>
        <button class="btn btn-secondary" data-field="username">Username</button>
      </div>
    </div>

    <!-- Purchases List -->
    <ul id="purchaseList" class="purchase-list">
      <% purchases.forEach((purchase) => { %>
        <li
          class="purchase-item"
          data-id="<%= purchase.id %>"
          data-username="<%= purchase.username %>"
          data-amount="<%= purchase.amount %>"
          data-status="<%= purchase.status %>"
          data-created="<%= purchase.created_at %>"
        >
          <strong><%= purchase.username %></strong> - <%= purchase.amount %> coins
          <br />
          Status: <%= purchase.status || 'N/A' %> | Created: <%= purchase.created_at %>
        </li>
      <% }) %>
    </ul>

    <!-- User Info Section -->
    <div id="userInfoContainer" class="user-info-container" style="display:none;">
      <h2 id="userInfoTitle"></h2>
      <p id="userEmail"></p>
      <p id="userBalance"></p>
      <h3>User Transactions:</h3>
      <ul id="userTransactions"></ul>
    </div>

    <!-- Confirm Purchase Modal -->
    <div id="confirmModal" class="modal-backdrop">
      <div class="modal-content">
        <h3 id="confirmMessage"></h3>
        <div class="modal-buttons">
          <button id="confirmYesBtn" class="btn btn-primary">Confirm</button>
          <button id="confirmNoBtn" class="btn btn-secondary">Cancel</button>
          <button id="confirmRejectBtn" class="btn btn-secondary">Reject</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Grab DOM elements
    const purchaseList = document.getElementById('purchaseList');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const sortContainer = document.getElementById('sortContainer');
    const userInfoContainer = document.getElementById('userInfoContainer');
    const userInfoTitle = document.getElementById('userInfoTitle');
    const userEmail = document.getElementById('userEmail');
    const userBalance = document.getElementById('userBalance');
    const userTransactions = document.getElementById('userTransactions');
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYesBtn = document.getElementById('confirmYesBtn');
    const confirmNoBtn = document.getElementById('confirmNoBtn');
    const confirmRejectBtn = document.getElementById('confirmRejectBtn');

    // For storing the last clicked purchase
    let selectedPurchase = null;

    // Filter / sort logic (client side)
    searchInput.addEventListener('input', () => filterPurchases());
    statusFilter.addEventListener('change', () => filterPurchases());
    sortContainer.addEventListener('click', (e) => {
      if (e.target.dataset.field) {
        sortPurchases(e.target.dataset.field);
      }
    });

    function filterPurchases() {
      const searchValue = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;

      const purchases = document.querySelectorAll('.purchase-item');
      purchases.forEach((item) => {
        const username = item.dataset.username.toLowerCase();
        const status = item.dataset.status;
        const matchSearch = username.includes(searchValue);
        const matchStatus = !statusValue || status === statusValue;
        
        item.style.display = (matchSearch && matchStatus) ? '' : 'none';
      });
    }

    function sortPurchases(field) {
      const purchasesArray = Array.from(document.querySelectorAll('.purchase-item'));
      let currentDirection = sortPurchases[field] === 'ASC' ? 'DESC' : 'ASC';
      sortPurchases[field] = currentDirection;

      purchasesArray.sort((a, b) => {
        const valA = a.dataset[field].toLowerCase();
        const valB = b.dataset[field].toLowerCase();

        if (valA < valB) return currentDirection === 'ASC' ? -1 : 1;
        if (valA > valB) return currentDirection === 'ASC' ? 1 : -1;
        return 0;
      });

      purchaseList.innerHTML = '';
      purchasesArray.forEach(item => purchaseList.appendChild(item));
    }

    // Single-click -> load user info
    purchaseList.addEventListener('click', async (e) => {
      const item = e.target.closest('.purchase-item');
      if (!item) return;

      selectedPurchase = item;
      const username = item.dataset.username;

      try {
        const res = await fetch(`/api/adminp/user-info/${username}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch user info');
        
        const data = await res.json();
        userInfoTitle.innerText = `User Details: ${data.user.username}`;
        userEmail.innerText = `Email: ${data.user.email}`;
        userBalance.innerText = `Balance: ${data.account.balance}`;

        userTransactions.innerHTML = '';
        data.transactions.forEach((tx) => {
          const li = document.createElement('li');
          li.innerText = `Type: ${tx.transaction_type} | Amount: ${tx.amount} | Status: ${tx.status} | Created: ${tx.created_at}`;
          userTransactions.appendChild(li);
        });

        userInfoContainer.style.display = 'block';
      } catch (err) {
        console.error(err);
        alert('Error fetching user details');
      }
    });

    // Double-click -> confirm modal
    purchaseList.addEventListener('dblclick', (e) => {
      const item = e.target.closest('.purchase-item');
      if (!item) return;
      selectedPurchase = item;
      confirmModal.classList.add('active');
      confirmMessage.textContent = `Are you sure you want to confirm this purchase for "${item.dataset.username}"?`;
    });

    // Confirm purchase => call server route
    confirmYesBtn.addEventListener('click', async () => {
      if (!selectedPurchase) return;
      const purchaseId = selectedPurchase.dataset.id;
      const amount = selectedPurchase.dataset.amount;
      const username = selectedPurchase.dataset.username;

      try {
        const res = await fetch(`/api/adminp/confirm-purchase/${purchaseId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, increaseAmount: amount }),
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to confirm purchase');
        
        alert('Purchase confirmed successfully.');
        confirmModal.classList.remove('active');
        location.reload();
      } catch (error) {
        console.error(error);
        alert('Failed to confirm purchase.');
      }
    });

    confirmNoBtn.addEventListener('click', () => {
      confirmModal.classList.remove('active');
    });

    // Reject purchase => call server route
    confirmRejectBtn.addEventListener('click', async () => {
      if (!selectedPurchase) return;
      const purchaseId = selectedPurchase.dataset.id;
      const amount = selectedPurchase.dataset.amount;
      const username = selectedPurchase.dataset.username;

      try {
        const res = await fetch(`/api/adminp/reject-purchase/${purchaseId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, increaseAmount: 0 }),
          credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to reject purchase');
        
        alert('Purchase rejected successfully.');
        confirmModal.classList.remove('active');
        location.reload();
      } catch (error) {
        console.error(error);
        alert('Failed to reject purchase.');
      }
    });
  </script>
</body>
</html>
